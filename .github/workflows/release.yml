name: Build and Release

on:
  push:
    tags:
      - "v*" # v1.0.0, v1.0.1 등으로 시작하는 태그가 푸시될 때 실행

# GitHub Actions가 Release를 생성하고 파일을 업로드할 수 있도록 권한 설정
permissions:
  contents: write

jobs:
  release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        # 3가지 OS에서 동시 빌드 (필요 없는 OS는 주석 처리 가능)
        os: [windows-latest, macos-latest, ubuntu-latest]
      fail-fast: false # 하나의 OS에서 실패해도 다른 OS는 계속 빌드

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 태그 정보를 포함한 전체 히스토리 가져오기

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # pnpm 설치 (package.json에 pnpm이 사용되므로 필수)
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # React/Vite 빌드
      - name: Build Renderer & Main
        run: pnpm build

      # Electron 패키징 및 GitHub Release 업로드
      # GH_TOKEN은 GitHub Actions가 자동으로 제공하는 시크릿입니다.
      - name: Publish App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm electron-builder --publish always
