name: Build & Release

on:
  push:
    tags:
      - "v*" # v1.0.0, v0.1.0 등의 태그가 푸시되면 실행
  workflow_dispatch: # 수동 실행 옵션

jobs:
  release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # 하나가 실패해도 다른 OS 빌드는 계속 진행
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # pnpm 캐싱을 위해 설정 (pnpm-lock.yaml이 있다면 활성화 권장)
          # cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # 리눅스 환경에서 rpm 빌드를 위한 필수 도구 설치
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm libarchive-tools

      # 의존성 설치 (각 OS에 맞는 네이티브 바이너리가 설치됨)
      - name: Install Dependencies
        run: pnpm install

      # Playwright 브라우저 설치 (리눅스 환경에서 필요할 수 있음)
      - name: Install Playwright Browsers
        if: matrix.os == 'ubuntu-latest'
        run: npx playwright install --with-deps

      # 소스 코드 빌드 (React/Vite -> Main/Renderer)
      - name: Build Source
        run: pnpm build

      # Electron 빌드 및 GitHub Release 업로드
      # GH_TOKEN은 GitHub Actions가 자동으로 생성해줍니다.
      - name: Package & Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx electron-builder --publish always
